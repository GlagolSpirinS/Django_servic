{% extends 'base/header.html' %}
{% load static %}

{% block content %}

<!-- ОСНОВНОЙ КОНТЕЙНЕР -->
<div class="container-main">
    <!-- КНОПКА СОЗДАНИЯ ЗАЯВКИ -->
    <div class="create-request-section">
        <button class="btn btn-primary btn-large" onclick="openModal()">
            Создать заявку
        </button>
    </div>

    <!-- УВЕДОМЛЕНИЯ -->
    {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
                <div class="message message-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- СПИСОК ЗАЯВОК -->
    <div class="requests-section">
        <h3 class="section-title">Мои заявки</h3>

        {% if user_requests %}
            <div class="requests-grid">
                {% for req in user_requests %}
                    <div class="request-card">
                        <div class="request-header">
                            <div class="request-info">
                                <strong class="request-number">Заявка #{{ req.id }}</strong>
                                <p class="request-meta">{{ req.get_device_type_display }} • {{ req.full_name }}</p>
                            </div>
                            <div class="request-date">{{ req.created_at|date:"d.m.Y H:i" }}</div>
                        </div>

                        <div class="request-details">
                            <p><strong>Телефон:</strong> {{ req.phone_number }}</p>
                            <p><strong>Адрес:</strong> {{ req.address|truncatechars:60 }}</p>
                        </div>

                        <div class="request-status">
                            <strong>Статус:</strong>
                            <span class="status-badge status-{{ req.status }}">
                                {{ req.get_status_display }}
                            </span>
                        </div>

                        {% if req.tags.all %}
                            <div class="request-tags">
                                {% for tag in req.tags.all %}
                                    {% if tag.name != "Проблема" %}
                                        <span class="tag" style="color: {{ tag.color }}; background-color: {{ tag.color }}22;">
                                            {{ tag.name }}
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if req.description %}
                            <p class="request-description">
                                {{ req.description|truncatechars:100 }}
                            </p>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="no-requests">У вас пока нет заявок.</p>
        {% endif %}
    </div>
</div>

<!-- POPUP МОДАЛЬНОЕ ОКНО -->
<div id="requestModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 class="modal-title">Форма заявки</h2>

        <form method="post" id="requestForm" class="modal-form">
            {% csrf_token %}

            <!-- Тип заказчика -->
            <div class="form-group">
                <label class="form-label"><strong>Тип заказчика</strong></label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="customer_type" value="individual" checked onchange="toggleLegalFields()">
                        Физическое лицо
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="customer_type" value="legal_entity" onchange="toggleLegalFields()">
                        Юридическое лицо
                    </label>
                </div>
            </div>

            <!-- Поля для юрлица -->
            <div id="legal-fields" class="legal-fields">
                <div class="form-group">
                    <label class="form-label">Название организации</label>
                    <input type="text" name="organization_name" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">ИНН</label>
                    <input type="text" name="inn" class="form-input" placeholder="10 или 12 цифр">
                </div>
            </div>

            <!-- Основные поля -->
            <div class="form-group">
                <label class="form-label"><strong>ФИО заказчика</strong></label>
                <input type="text" name="full_name" required class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label"><strong>Телефон</strong></label>
                <input type="tel" name="phone_number" required class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label"><strong>Адрес</strong></label>
                <textarea name="address" required class="form-textarea" rows="2"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Telegram / WhatsApp</label>
                <input type="text" name="external_links" class="form-input" 
                       placeholder="Например: @username, +79991234567">
            </div>

            <div class="form-group">
                <label class="form-label"><strong>Email</strong></label>
                <input type="email" value="{{ user.email }}" readonly class="form-input readonly">
            </div>

            <div class="form-group">
                <label class="form-label"><strong>Тип устройства</strong></label>
                <select name="device_type" required class="form-select">
                    {% for value, label in device_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Симптомы -->
            <div class="form-group">
                <label class="form-label"><strong>Симптомы неисправности</strong></label>
                <div class="issues-grid">
                    {% for issue in issue_choices %}
                        <label class="checkbox-label">
                            <input type="checkbox" name="issues" value="{{ issue.code }}">
                            {{ issue.get_code_display|default:issue.description }}
                        </label>
                    {% endfor %}
                </div>
                <input type="text" name="issues_other" class="form-input" 
                       placeholder="Другие симптомы..." style="margin-top: 8px;">
            </div>

            <div class="form-group">
                <label class="form-label">Дополнительное описание</label>
                <textarea name="description" class="form-textarea" 
                          rows="2" placeholder="Расскажите подробнее..."></textarea>
            </div>

            <button type="submit" class="btn btn-primary btn-submit">
                Отправить заявку
            </button>
        </form>
    </div>
</div>

<!-- ОВЕРЛЕЙ -->
<div id="modal-overlay" class="modal-overlay" onclick="closeModal()"></div>

<!-- СТИЛИ -->
<style>
    /* ОСНОВНЫЕ СТИЛИ */
    .container-main {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }

    .create-request-section {
        text-align: center;
        margin-bottom: 24px;
    }

    .btn-large {
        padding: 12px 32px;
        font-size: 16px;
        font-weight: 600;
    }

    /* УВЕДОМЛЕНИЯ */
    .messages-container {
        max-width: 600px;
        margin: 0 auto 24px;
    }

    .message {
        padding: 10px 16px;
        border-radius: 6px;
        margin: 8px 0;
        text-align: center;
        font-weight: 500;
    }

    .message-error { background: #dc3545; color: white; }
    .message-success { background: #28a745; color: white; }
    .message-warning { background: #ffc107; color: #000; }

    /* СПИСОК ЗАЯВОК */
    .requests-section {
        margin-top: 32px;
    }

    .section-title {
        color: white;
        text-align: center;
        margin-bottom: 20px;
        font-size: 1.5rem;
    }

    .requests-grid {
        display: grid;
        gap: 12px;
    }

    .request-card {
        background: #1a1d25;
        border: 1px solid #2d323d;
        border-radius: 8px;
        padding: 16px;
        color: white;
    }

    .request-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
    }

    .request-number {
        font-size: 1.1rem;
    }

    .request-meta {
        margin: 4px 0 0 0;
        font-size: 0.9em;
        color: #aaa;
    }

    .request-date {
        font-size: 0.85em;
        color: #999;
    }

    .request-details {
        margin-bottom: 12px;
    }

    .request-details p {
        margin: 4px 0;
    }

    .request-status {
        margin: 12px 0;
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 500;
        margin-left: 8px;
    }

    .status-waiting {
         background: #3c2415;
          color: #fb923c;
          border-radius: 8px;
          
        }
    .status-working {
         background: #122227;
          color: #0891b2;
          border-radius: 8px;
        }
    .status-finish { 
        background: #163020;
        color: #16a34a; 
        border-radius: 8px;
    }

    .request-tags {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin: 8px 0;
    }

    .tag {
        padding: 3px 8px;
        border-radius: 8px;
        font-size: 0.8em;
        font-weight: 500;
        /* Обновленные стили тегов как во втором шаблоне */
        color: var(--tag-color);
        background-color: var(--tag-bg-color);
    }

    .request-description {
        margin: 8px 0 0 0;
        font-size: 0.9em;
        color: #ccc;
        line-height: 1.4;
    }

    .no-requests {
        color: #888;
        text-align: center;
        margin-top: 20px;
        font-style: italic;
    }

    /* ФОРМА */
    .modal-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-label {
        font-weight: 500;
        color: #e9ecef;
    }

    .form-input,
    .form-textarea,
    .form-select {
        width: 100%;
        padding: 10px 12px;
        background: #1a1d25;
        border: 1px solid #2d323d;
        color: white;
        border-radius: 6px;
        font-size: 14px;
    }

    .form-input.readonly {
        background: #2d323d;
        color: #a3a3a3;
        cursor: not-allowed;
    }

    .form-textarea {
        resize: vertical;
        min-height: 60px;
    }

    .radio-group {
        display: flex;
        gap: 20px;
        margin: 6px 0;
    }

    .radio-label {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
    }

    .issues-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin: 6px 0;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9em;
        cursor: pointer;
    }

    .legal-fields {
        display: none;
        flex-direction: column;
        gap: 12px;
        margin: 8px 0;
    }

    .btn-submit {
        align-self: center;
        margin-top: 16px;
        padding: 12px 32px;
    }

    /* МОДАЛЬНОЕ ОКНО */
    .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.7);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
    }

    .modal.active {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }

    .modal-content {
        background: #1a1d25;
        padding: 24px;
        border-radius: 8px;
        border: 1px solid #2d323d;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        position: relative;
        max-height: 85vh;
        overflow-y: auto;
    }

    .modal-title {
        margin: 0 0 20px 0;
        color: white;
        text-align: center;
    }

    .close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        font-size: 24px;
        color: #888;
        cursor: pointer;
        background: none;
        border: none;
    }

    .close-btn:hover {
        color: white;
    }

    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 999;
    }

    /* СКРОЛЛБАР */
    .modal-content::-webkit-scrollbar {
        width: 6px;
    }

    .modal-content::-webkit-scrollbar-track {
        background: #1a1d25;
    }

    .modal-content::-webkit-scrollbar-thumb {
        background: #2d323d;
        border-radius: 3px;
    }
</style>

<!-- СКРИПТЫ -->
<script>
    function openModal() {
        document.getElementById('requestModal').classList.add('active');
        document.getElementById('modal-overlay').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        document.getElementById('requestModal').classList.remove('active');
        setTimeout(() => {
            document.getElementById('modal-overlay').style.display = 'none';
            document.body.style.overflow = 'auto';
        }, 300);
    }

    function toggleLegalFields() {
        const legalRadio = document.querySelector('input[value="legal_entity"]');
        const legalFields = document.getElementById('legal-fields');
        legalFields.style.display = legalRadio.checked ? 'flex' : 'none';
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });

    document.getElementById('modal-overlay').onclick = closeModal;
    window.onload = toggleLegalFields;
</script>

{% endblock %}